<script>
    // --- CONSTANTES GLOBALES (para Doorbin Waste LLC - SERVICE PROVIDER) ---
    const SERVICE_PROVIDER_DETAILS = {
        name: 'Doorbin Waste LLC',
        address_line: '8601 SW 107th Ave Suite 100', // Ejemplo: Reemplazar con la dirección real de Doorbin Waste
        city: 'Miami',
        state: 'FL',
        zip_code: '33176'
    };

    // --- Data Store: Define todos los campos que el contrato puede necesitar ---
    const contractData = {
        // Datos del CLIENTE/PROPIEDAD (de Airtable/URL)
        client_name: 'Pending Client', // Corresponde a "Client Name (from Client)"
        property_id: 'Pending ID', // Para Airtable lookup
        property_name: 'Pending Property', // Corresponde a "Property Name"
        property_address: 'Pending Address', // Corresponde a "Property Address"
        property_city: 'Pending City', // Corresponde a "City"
        property_state: 'Pending State', // Corresponde a "State"
        property_zip_code: 'Pending ZIP', // Corresponde a "ZIP Code"
        total_units: 'Pending', // Corresponde a "Total Number of Units"
        start_date: 'Pending', // Corresponde a "Start Date"

        // Datos del Servicio/Contrato (podrían venir de Airtable o ser defaults)
        service_frequency: '5x/week', // Default
        monthly_rate: '0.00', // Default
        initial_term_months: '12', // Default
        termination_notice_days: '90', // Default
        service_window_start_time: '6pm', // Default
        service_window_end_time: '9pm', // Default
        billing_day_of_month: '1', // Default
        payment_terms_days: '15', // Default
        grievance_resolution_hours: '48' // Default
    };

    // --- UI State ---
    const ui = {
        page1: document.getElementById('page-1'),
        page2: document.getElementById('page-2'),
        check1: document.getElementById('check-1'),
        check2: document.getElementById('check-2'),
        submitBtn: document.getElementById('submit-btn'),
        errorMsg: document.getElementById('error-msg'),
        termsContent: document.getElementById('terms-content'),
        // Hidden fields para el POST
        hidClientName: document.getElementById('hid-client-name'),
        hidPropertyId: document.getElementById('hid-property-id'),
        hidPropertyName: document.getElementById('hid-property-name'),
        hidTotalUnits: document.getElementById('hid-total-units'),
        hidServiceFrequency: document.getElementById('hid-service-frequency'),
        hidStartDate: document.getElementById('hid-start-date'),
        hidMonthlyRate: document.getElementById('hid-monthly-rate'),
    };

    // --- Formatter utilities ---
    const formatDisplayDate = (str) => {
        if (!str || str === 'Pending') return 'Pending';
        // Asume formato YYYY-MM-DD para convertir a MM/DD/YYYY
        const date = new Date(str + 'T00:00:00'); // Añade T00:00:00 para evitar problemas de zona horaria
        if (isNaN(date.getTime())) return str; // Si no es una fecha válida, devuelve la original
        return date.toLocaleDateString('en-US', { year: 'numeric', month: '2-digit', day: '2-digit' });
    };
    
    const formatDisplayCurrency = (val) => {
        if (!val || val === 'Pending') return 'Pending';
        const numeric = parseFloat(val.toString().replace(/[^0-9.]/g, ''));
        if (isNaN(numeric)) return val;
        return '$' + numeric.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
    };

    // --- Initialize App ---
    function init() {
        document.getElementById('year').textContent = new Date().getFullYear();

        // 1. Read URL Parameters
        const params = new URLSearchParams(window.location.search);
        // Lista de todos los query parameters que esperamos
        const paramKeys = [
            'client_name', 'property_id', 'property_name', 'property_address', 'property_city',
            'property_state', 'property_zip_code', 'total_units', 'start_date',
            'service_frequency', 'monthly_rate', 'initial_term_months',
            'termination_notice_days', 'service_window_start_time',
            'service_window_end_time', 'billing_day_of_month', 'payment_terms_days',
            'grievance_resolution_hours'
        ];

        paramKeys.forEach(key => {
            const val = params.get(key);
            if (val) {
                // Decodifica para manejar espacios y caracteres especiales de la URL
                contractData[key] = decodeURIComponent(val.replace(/\+/g, ' '));
            }
        });

        // 2. Populate Form Hidden Fields (Asegúrate de que los IDs coincidan con los nuevos nombres)
        if (ui.hidClientName) ui.hidClientName.value = contractData.client_name;
        if (ui.hidPropertyId) ui.hidPropertyId.value = contractData.property_id;
        if (ui.hidPropertyName) ui.hidPropertyName.value = contractData.property_name;
        if (ui.hidTotalUnits) ui.hidTotalUnits.value = contractData.total_units;
        if (ui.hidServiceFrequency) ui.hidServiceFrequency.value = contractData.service_frequency;
        if (ui.hidStartDate) ui.hidStartDate.value = contractData.start_date;
        if (ui.hidMonthlyRate) ui.hidMonthlyRate.value = contractData.monthly_rate;
        // Si necesitas enviar más campos vía POST, añade más hidden inputs en el HTML
        // y aquí en el JavaScript para rellenarlos.

        // 3. Set Up Terms Content
        generateTerms();

        // 4. Event Listeners
        if (ui.check1) ui.check1.addEventListener('change', validateForm);
        if (ui.check2) ui.check2.addEventListener('change', validateForm);
        const linkToTermsBtn = document.getElementById('link-to-terms');
        if (linkToTermsBtn) linkToTermsBtn.addEventListener('click', () => switchPage(2));
        const backTo1Btn = document.getElementById('back-to-1');
        if (backTo1Btn) backTo1Btn.addEventListener('click', () => switchPage(1));
    }

    function validateForm() {
        const isValid = ui.check1.checked && ui.check2.checked;
        ui.submitBtn.disabled = !isValid;
        
        if (isValid) {
            ui.submitBtn.classList.remove('bg-gray-800', 'text-gray-600', 'cursor-not-allowed');
            ui.submitBtn.classList.add('bg-accent-lime', 'text-[#121212]', 'hover:brightness-110');
            if (ui.errorMsg) ui.errorMsg.classList.add('hidden');
        } else {
            ui.submitBtn.classList.add('bg-gray-800', 'text-gray-600', 'cursor-not-allowed');
            ui.submitBtn.classList.remove('bg-accent-lime', 'text-[#121212]', 'hover:brightness-110');
            if (ui.errorMsg) ui.errorMsg.classList.remove('hidden');
        }
    }

    function switchPage(pageNumber) {
        if (pageNumber === 1) {
            ui.page1.classList.remove('hidden');
            ui.page2.classList.add('hidden');
            window.scrollTo(0,0);
        } else {
            ui.page1.classList.add('hidden');
            ui.page2.classList.remove('hidden');
            window.scrollTo(0,0);
        }
    }

    // --- generateTerms: Actualizado con todos los nuevos campos ---
    function generateTerms() {
        const termsTemplate = `
            <div class="space-y-6">
                <h2 class="text-white font-bold text-xl uppercase tracking-tight text-center border-b border-gray-800 pb-4">DOOR-TO-DOOR WASTE COLLECTION SERVICE AGREEMENT</h2>
                
                <p><strong>BETWEEN:</strong></p>
                <p><strong>${SERVICE_PROVIDER_DETAILS.name}</strong>, a limited liability company organized and registered under the laws of the State of Florida, with its business address at <strong>${SERVICE_PROVIDER_DETAILS.address_line}, ${SERVICE_PROVIDER_DETAILS.city}, ${SERVICE_PROVIDER_DETAILS.state} ${SERVICE_PROVIDER_DETAILS.zip_code}</strong>, hereinafter referred to as the <strong>"SERVICE PROVIDER"</strong>, specialized in door-to-door waste collection, recycling, and waste management in multi-family residential properties and condominiums.</p>
                
                <p><strong>AND:</strong></p>
                <p><strong>${contractData.client_name}</strong>, a property/condominium association duly organized and registered under the laws of the State of <strong>${contractData.property_state}</strong>, with address at <strong>${contractData.property_address}, ${contractData.property_city}, ${contractData.property_state} ${contractData.property_zip_code}</strong>, hereinafter referred to as the <strong>"CLIENT"</strong>.</p>

                <h3 class="text-white font-bold text-lg border-b border-gray-800 pb-2">DECLARATIONS</h3>
                <ol class="list-decimal pl-5 space-y-2">
                    <li>The <strong>SERVICE PROVIDER</strong> possesses the capacity, experience, and technical/legal resources to provide Valet Trash services, including the safe and proper handling of all waste generated on the property.</li>
                    <li>The <strong>CLIENT</strong> manages the property and has the authority to contract and supervise the services to be provided to residents.</li>
                </ol>

                <h3 class="text-white font-bold text-lg border-b border-gray-800 pb-2">CLAUSES</h3>
                
                <p><strong>FIRST – SCOPE OF THE CONTRACT:</strong> The SERVICE PROVIDER shall provide door-to-door waste collection services to all units and common areas of the property located at <strong>${contractData.property_address}, ${contractData.property_city}, ${contractData.property_state} ${contractData.property_zip_code}</strong> comprising <strong>${contractData.total_units}</strong> units, in accordance with the schedule, routes, and frequency agreed upon.</p>

                <p><strong>SECOND – DURATION:</strong> This contract shall have an initial duration of <strong>${contractData.initial_term_months}</strong> months/years, commencing on <strong>${formatDisplayDate(contractData.start_date)}</strong>. It shall automatically renew for equal periods unless written notice of non-renewal is provided at least <strong>${contractData.termination_notice_days}</strong> days in advance.</p>

                <p><strong>THIRD – FREQUENCY AND SCHEDULE:</strong> Waste collection will occur at a frequency of <strong>${contractData.service_frequency}</strong>. Collection hours are set between <strong>${contractData.service_window_start_time}</strong> and <strong>${contractData.service_window_end_time}</strong>. Holidays will be compensated according to a pre-communicated schedule.</p>

                <p><strong>FOURTH – OBLIGATIONS OF THE SERVICE PROVIDER:</strong>
                    <ul class="list-disc pl-5 space-y-2">
                        <li>Collect waste from all units and common areas according to the agreed schedule.</li>
                        <li>Provide necessary containers and equipment.</li>
                        <li>Maintain vehicles and equipment in optimal condition, complying with safety and environmental regulations.</li>
                        <li>Provide monthly reports or upon request via the Service App (including photos of daily daily service).</li>
                    </ul>
                </p>

                <p><strong>FIFTH – OBLIGATIONS OF THE CLIENT:</strong>
                    <ul class="list-disc pl-5 space-y-2">
                        <li>Facilitate access to units and common areas for collection.</li>
                        <li>Inform residents about service policies.</li>
                        <li>Pay invoices punctually according to the agreed monthly rate of <strong>${formatDisplayCurrency(contractData.monthly_rate)}</strong>.</li>
                    </ul>
                </p>

                <p><strong>SIXTH – PRICE AND PAYMENT TERMS:</strong> The agreed rate is <strong>${formatDisplayCurrency(contractData.monthly_rate)}</strong> per month. Billing occurs on the <strong>${contractData.billing_day_of_month}</strong> of each month. Payments are due within <strong>${contractData.payment_terms_days}</strong> days after the invoice date. Late payments may incur a monthly penalty fee.</p>

                <p><strong>SEVENTH – LIABILITY AND INSURANCE:</strong> The SERVICE PROVIDER shall be liable for direct damages caused by proven negligence. The SERVICE PROVIDER maintains general liability insurance, vehicle insurance, and workers' compensation as required by law.</p>

                <p><strong>EIGHTH – RESIDENT GRIEVANCE PROCEDURE:</strong> Residents may report issues directly to the CLIENT or via the Service Provider's reporting channel. SERVICE PROVIDER shall resolve incidents within a maximum period of <strong>${contractData.grievance_resolution_hours}</strong> hours.</p>

                <p><strong>NINTH – EARLY TERMINATION:</strong> Either party may terminate the contract with written notice for breach of contract or non-payment.</p>

                <div class="pt-8 border-t border-gray-800 text-xs text-gray-500 italic">
                    By signing this digital document, both parties agree to the terms and conditions outlined above. This electronic acceptance constitutes a legally binding agreement for the property at <strong>${contractData.property_name}</strong>.
                </div>
            </div>
        `;
        ui.termsContent.innerHTML = termsTemplate;
    }

    // Run init
    init();
</script>
